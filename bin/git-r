#!/bin/bash
#
# Interactively rebase, against master by default.

source ~/.bash.d/git

set -u -o pipefail

# check if we're currently in a rebase
# https://stackoverflow.com/a/3921928
if [[ -d "$(git rev-parse --git-path rebase-merge)" ]]; then
    git rebase "$@"
    exit
fi

ARGS=("-i")
NO_ARGS=1

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        (*)
            NO_ARGS=0
            ARGS+=("$1")
        ;;
    esac
    shift
done

if [[ -n "$(git ls-files -m)" ]]; then
    echo "Saving work..."
    git wip
fi

if [[ "${NO_ARGS}" == 1 ]]; then
    if [[ "$(git rev-parse --abbrev-ref HEAD)" == master ]]; then
        ARGS+=('HEAD~10')
    else
        ARGS+=("$(git log --merges -n1 --pretty='format:%H')")
    fi
fi

git rebase "${ARGS[@]}"
