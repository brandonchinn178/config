#!/bin/bash
#
# Interactively rebase, against master by default.

source ~/.bash.d/git

set -u -o pipefail

# check if we're currently in a rebase
# https://stackoverflow.com/a/3921928
if [[ -d "$(git rev-parse --git-path rebase-merge)" ]]; then
    git rebase "$@"
    exit
fi

ARGS=()

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        (last-merge) ARGS+=("$(git log --merges -n1 --pretty='format:%H')") ;;
        (*) ARGS+=("$1") ;;
    esac
    shift
done

if [[ -n "$(git ls-files -m)" ]]; then
    echo "Saving work..."
    git wip
fi

if [[ "${#ARGS[@]}" == 0 ]]; then
    if [[ "$(git rev-parse --abbrev-ref HEAD)" == master ]]; then
        ARGS+=('HEAD~10')
    else
        ARGS+=("master")
    fi
fi

git rebase -i "${ARGS[@]}"
