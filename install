#!/usr/bin/env zsh

set -ex

cd "$(dirname "${0:A}")"

files=(
    bash-completion
    bin
    gitconfig
    inputrc
    vim
    vimrc
    zsh-completion
    zshrc
)

for file in "${files[@]}"; do
    dest="${HOME}/.${file}"
    rm -rf $dest
    ln -sf "${PWD}/${file}" "$dest"
done

############### Upstream completion scripts ###############

function download_file {
    local src=$1
    local dest=$2
    shift 2

    if [[ ! -f $dest ]]; then
        mkdir -p "$(dirname $dest)"
        curl -o $dest $src "$@"
    fi
}

function gh_url {
    local repo=$1
    local tag=$2
    local path=$3
    echo "https://raw.githubusercontent.com/${repo}/${tag}/${path}"
}

git_version='2.24.3'
git_completion_url="https://raw.githubusercontent.com/git/git/v${git_version}/contrib/completion"
download_file "$(gh_url 'git/git' 'v2.24.3' 'contrib/completion/git-completion.bash')" ~/.bash-completion/git-completion.bash
download_file "$(gh_url 'git/git' 'v2.24.3' 'contrib/completion/git-completion.zsh')" ~/.zsh-completion/_git

download_file "$(gh_url 'docker/cli' 'v20.10.2' 'contrib/completion/zsh/_docker')" ~/.zsh-completion/_docker
download_file "$(gh_url 'docker/compose' '1.27.4' 'contrib/completion/zsh/_docker-compose')" ~/.zsh-completion/_docker-compose

############### Brew dependencies ###############

if ! type brew &> /dev/null; then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

brew bundle
